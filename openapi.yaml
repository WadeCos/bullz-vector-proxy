openapi: 3.0.3
info:
  title: Bullz Vector Proxy
  version: "1.0.3"
  description: Upload documents into your OpenAI Vector Store and run namespace-scoped searches.
servers:
  - url: https://bullz-vector-proxy.onrender.com
components:
  securitySchemes:
    ActionSecret:
      type: apiKey
      in: header
      name: X-Action-Secret
  schemas:
    InfoResponse:
      type: object
      properties:
        vector_store_id: { type: string }
        vector_store_name: { type: string }
      required: [vector_store_id]
      additionalProperties: false
    DiagResponse:
      type: object
      properties:
        has_openai_key: { type: boolean }
        vector_store_id: { type: string }
        beta_header_expected: { type: string }
      required: [has_openai_key]
      additionalProperties: true
    AuthcheckResponse:
      type: object
      properties:
        ok: { type: boolean }
      required: [ok]
      additionalProperties: false
    UploadResponse:
      type: object
      properties:
        ok: { type: boolean }
        file_id: { type: string }
        namespace: { type: string }
      required: [ok]
      additionalProperties: true
    SearchResponse:
      type: object
      properties:
        ok: { type: boolean }
        variant: { type: string }
        response: { type: object, additionalProperties: true }
        attempts:
          type: array
          items: { type: object, additionalProperties: true }
      required: [ok]
      additionalProperties: true

paths:
  /info:
    get:
      operationId: getInfo
      summary: Service + vector store info
      security: [ { ActionSecret: [] } ]
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/InfoResponse' }

  /diag:
    get:
      operationId: getDiag
      summary: Diagnostics (keys present, expected headers)
      security: [ { ActionSecret: [] } ]
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/DiagResponse' }

  /authcheck:
    post:
      operationId: postAuthcheck
      summary: Verify X-Action-Secret header is correct
      security: [ { ActionSecret: [] } ]
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/AuthcheckResponse' }
        "401":
          description: Missing or invalid X-Action-Secret

  /upload:
    post:
      operationId: postUpload
      summary: Upload a file and attach it to the configured vector store
      security: [ { ActionSecret: [] } ]
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required: [file]
              properties:
                file:
                  type: string
                  format: binary
                namespace:
                  type: string
                  description: Logical bucket (e.g., daytrading, options, psychology)
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/UploadResponse' }
        "400":
          description: Bad request

  /search:
    post:
      operationId: postSearch
      summary: Query the vector store (auto-tries multiple payload variants)
      security: [ { ActionSecret: [] } ]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [query]
              properties:
                query:     { type: string }
                top_k:     { type: integer, default: 6 }
                namespace: { type: string }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/SearchResponse' }
        "400":
          description: Bad request
        "429":
          description: Upstream quota issue
